<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="format-detection" content="telephone=no">
  <title>ãƒ‹ã‚¸çœ‹è­· - ã‚ãªãŸã«åˆã†æ±‚äººã‚’è¦‹ã¤ã‘ã‚ˆã†</title>
  <meta name="description" content="ç°¡å˜ãªè³ªå•ã«ç­”ãˆã‚‹ã ã‘ã§ã€ã‚ãªãŸã«ã´ã£ãŸã‚Šã®æ±‚äººã‚’ã”ææ¡ˆã—ã¾ã™ã€‚ç´„1åˆ†ã§å®Œäº†ï¼">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="icon.jpg">

  <!-- Preconnect -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="styles.css">

  <style>
    body {
      font-family: 'Noto Sans JP', 'Hiragino Sans', sans-serif;
    }
  </style>
</head>

<body>
  <div class="app-container" id="app">
    <!-- Header -->
    <header class="header">
      <div class="header__logo">
        <img src="logo.png" alt="ãƒ‹ã‚¸çœ‹è­·" class="header__logo-img">
      </div>
    </header>

    <!-- Stats Section -->
    <section class="stats-section">
      <div class="stats-card">
        <p class="stats-card__title">ç™»éŒ²ã‹ã‚‰å†…å®šå¾Œã¾ã§å®Œå…¨ç„¡æ–™ã§ã‚µãƒãƒ¼ãƒˆ</p>
        <div class="stats-card__items">
          <div class="stats-item">
            <span class="stats-item__icon">ğŸ“ˆ</span>
            <span>æœªçµŒé¨“è·ç¨®ã¸ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸å¯èƒ½ï¼</span>
          </div>
          <div class="stats-item">
            <span class="stats-item__icon">âš¡</span>
            <span>å†…å®šã¾ã§æœ€çŸ­ <span class="stats-item__value">2æ—¥</span> ãƒ»å¹³å‡26æ—¥</span>
          </div>
          <div class="stats-item">
            <span class="stats-item__icon">ğŸš€</span>
            <span>ã“ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã«å›ç­”å¾Œ <span class="stats-item__value">3ç§’</span> ã§æ±‚äººææ¡ˆï¼</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Live Counter -->
    <div class="live-counter">
      <span class="live-counter__dot"></span>
      <span class="live-counter__text">
        ç¾åœ¨ <span class="live-counter__number" id="liveCount">47</span> äººãŒè»¢è·æ´»å‹•ä¸­ã§ã™ï¼
      </span>
    </div>

    <!-- Progress Section -->
    <section class="progress-section">
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-bar__fill" id="progressFill" style="width: 0%"></div>
        </div>
        <span class="progress-text" id="progressText"><span class="progress-number">0</span>/4</span>
      </div>
    </section>

    <!-- Chat Area -->
    <main class="chat-area" id="chatArea">
      <!-- Chat bubbles will be dynamically inserted here -->
    </main>

    <!-- Diagnosis Result Screen (hidden initially, content generated by JS) -->
    <div class="hidden" id="diagnosisScreen">
      <!-- diagnosis result content will be dynamically inserted by app.js -->
    </div>

    <!-- Loading Overlay (hidden initially) -->
    <div class="loading-overlay hidden" id="loadingOverlay">
      <div class="loading-overlay__content">
        <div class="loading-overlay__spinner"></div>
        <p class="loading-overlay__text">
          é€ä¿¡ä¸­<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>
        </p>
      </div>
    </div>
  </div>

  <!-- LIFF SDK -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- LIFFåˆæœŸåŒ– + ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾— + è‡ªå‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbwgGfNXsduo1lZWAAbwJz-xdrAsXp3zTeiOx-KIrvtC4AK_09q7nV-ZYYRxoeIbXBrzqw/exec';

    window.__liffReady = (async function () {
      const LIFF_ID = '2009139815-KlyH45dv';

      try {
        await liff.init({ liffId: LIFF_ID });

        const inClient = liff.isInClient();
        let contextType = 'unknown';
        try { contextType = liff.getContext()?.type || 'none'; } catch (e) {}
        console.log('[LIFF] init OK | inClient:', inClient, '| context:', contextType);

        if (inClient) {
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå–å¾—ï¼ˆIDãƒˆãƒ¼ã‚¯ãƒ³å„ªå…ˆã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§getProfileï¼‰
          try {
            const idToken = liff.getDecodedIDToken();
            if (idToken && idToken.sub) {
              window.__liffUserId = idToken.sub;
            }
          } catch (e) {
            console.log('[LIFF] getDecodedIDToken failed:', e.message || e);
          }

          if (!window.__liffUserId) {
            try {
              const profile = await liff.getProfile();
              window.__liffUserId = profile.userId;
            } catch (e) {
              console.log('[LIFF] getProfile failed:', e.message || e);
            }
          }

          console.log('[LIFF] userId:', window.__liffUserId || 'NOT_FOUND');

          // ã€Œã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”ä¸­ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è‡ªå‹•é€ä¿¡
          let messageSent = false;
          try {
            await liff.sendMessages([{
              type: 'text',
              text: 'è‡ªå‹•ï¼šã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”ä¸­'
            }]);
            messageSent = true;
            console.log('[LIFF] sendMessages OK');
          } catch (sendError) {
            console.error('[LIFF] sendMessages FAILED:', sendError.code || '', sendError.message || sendError);
          }

          // sendMessageså¤±æ•—æ™‚ â†’ GASçµŒç”±ã§BOTã‹ã‚‰é€šçŸ¥ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
          if (!messageSent && window.__liffUserId) {
            try {
              fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                  action: 'survey_started',
                  lineId: window.__liffUserId
                })
              });
              console.log('[LIFF] Fallback: notified GAS survey_started');
            } catch (e) {
              console.log('[LIFF] Fallback failed:', e);
            }
          }
        } else {
          console.log('[LIFF] Not in LINE client');
        }
      } catch (e) {
        console.error('[LIFF] init FAILED:', e.code || '', e.message || e);
      }
    })();
  </script>

  <!-- Scripts -->
  <script src="questions.js"></script>
  <script src="app.js"></script>
</body>

</html>